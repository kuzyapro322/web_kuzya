{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block script %}{% endblock %}

{% block main %}

<div class="new-year-theme">
    <h1 style="color:white"> –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è </h1>
    
    
    <div class="user-panel">
        {% if is_authenticated %}
        <div>
            <span class="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong>{{ name }}</strong>!</span>
            <a href="{{ url_for('lab9.logout') }}" style="margin: 5px; color:white;">–í—ã–π—Ç–∏</a>
        </div>
        {% else %}
        <div style="margin: 10px;">
            <a href="{{ url_for('lab9.login') }}" class="btn login-btn">–í–æ–π—Ç–∏</a>
            <a href="{{ url_for('lab9.register') }}" class="btn register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </div>
        {% endif %}
    </div>
    
    <div class="stats-panel">
        <p>–í—ã –æ—Ç–∫—Ä—ã–ª–∏: <span id="user-opened-count">{{ opened_count }}</span> –∏–∑ 3 –∫–æ—Ä–æ–±–æ–∫</p>
        <p>–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—ã—Ö: <span id="closed-count">{{ closed_count }}</span></p>
        {% if is_authenticated %}
        <p class="auth-status"> –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫: {{ user_login }}</p>
        {% else %}
        <p class="auth-status">–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
        {% endif %}
    </div>
    
    {% if is_authenticated %}
    <div class="santa-panel">
        <h3>–ü–∞–Ω–µ–ª—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞</h3>
        <button id="reset-btn" class="btn santa-btn">–ù–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ</button>
    </div>
    {% endif %}
    

    <div id="gift-popup" class="gift-popup" style="display: none;">
        <div class="gift-popup-content">
            <button class="close-popup" onclick="closeGiftPopup()">√ó</button>
            <h3> –í–∞—à –ø–æ–¥–∞—Ä–æ–∫!</h3>
            <p id="gift-message-text"></p>
            <div id="gift-preview"></div>
            <button class="ok-button" onclick="closeGiftPopup()">OK</button>
        </div>
    </div>
    
    
    
    <div class="boxes-container">
        {% for box in boxes %}
        <div class="gift-box {% if box.is_opened %}opened{% endif %} {% if box.requires_auth %}requires-auth{% endif %}" 
             data-id="{{ box.box_id }}"
             data-gift="{{ box.gift_image }}"
             data-message="{{ box.message }}"
             data-requires-auth="{{ box.requires_auth }}"
             style="left: {{ positions[loop.index0][0] }}%; top: {{ positions[loop.index0][1] }}%;">
            <div class="box-content">
                {% if box.is_opened %}
                    <div class="after-open-box">
                        <img src="/static/lab9/opened_box.png" alt="–û—Ç–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞" class="box-img">
                    </div>
                    <div class="box-status">–û—Ç–∫—Ä—ã—Ç–∞</div>
                {% else %}
                    <div class="before-open-box">
                        <img src="/static/lab9/box_closed_{{ loop.index }}.png" alt="–ö–æ—Ä–æ–±–∫–∞ {{ loop.index }}" class="box-img">
                        
                    </div>
                    <div class="box-status">–ó–∞–∫—Ä—ã—Ç–∞</div>
                {% endif %}
                <div class="box-number">
                    –ö–æ—Ä–æ–±–∫–∞ {{ loop.index }}
                    {% if box.requires_auth %}
                    <span class="auth-badge">üîí</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="hint">
        <p> <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ö–æ—Ä–æ–±–∫–∏ —Å —Å–∏–º–≤–æ–ª–æ–º üîí –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!</p>
      
    </div>
</div>

<script>
// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫
let openedBoxes = [];

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ä–æ–±–∫–∏
function openBox(boxId) {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–æ–±–∫—É —á–µ—Ä–µ–∑ API
    fetch(`/lab9/rest-api/boxes/${boxId}/open`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json'
        }
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) { 
                throw err; 
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            if (data.requires_auth) {
                showAuthPopup(boxId);
            } else {
                showError(data.error);
            }
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('user-opened-count').textContent = data.user_opened_count;
            document.getElementById('closed-count').textContent = data.closed_count;
            
            showGiftPopup(data.message, data.gift);
            
            updateBoxAfterOpen(boxId, data.gift);
            
            openedBoxes.push(boxId);
        }
    })
    .catch(function(error) {
        if (error.requires_auth) {
            showAuthPopup(boxId);
        } else {
            showError(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏');
        }
    });
}
// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–∞ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function showAuthPopup(boxId) {
    document.getElementById('auth-popup-text').textContent = 
        `–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ä–æ–±–∫–∏ ${parseInt(boxId) + 1} –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.`;
    document.getElementById('auth-popup').style.display = 'flex';
}

function closeAuthPopup() {
    document.getElementById('auth-popup').style.display = 'none';
}
// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –∫–æ—Ä–æ–±–æ–∫ (—Ñ—É–Ω–∫—Ü–∏—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞)
function resetAllBoxes() {
    if (!confirm(' –î–µ–¥ –ú–æ—Ä–æ–∑, –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ?')) {
        return;
    }
    
    fetch('/lab9/rest-api/boxes/reset', {
        method: 'POST'
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(err) { 
                throw err; 
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            showError(data.error);
        } else {
            alert(data.message);
            location.reload(); 
        }
    })
    .catch(function(error) {
        showError(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ—Ä–æ–±–æ–∫');
    });
}


function showError(message) {
    alert(message);
}
// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–∞
function closeGiftPopup() {
    document.getElementById('gift-popup').style.display = 'none';
}

function showGiftPopup(message, giftImage) {
    document.getElementById('gift-message-text').textContent = message;
    document.getElementById('gift-preview').innerHTML = `<img src="/static/lab9/${giftImage}" alt="–í–∞—à –ø–æ–¥–∞—Ä–æ–∫">`;
    document.getElementById('gift-popup').style.display = 'flex';
}

function updateBoxAfterOpen(boxId, giftImage) {
    const boxElement = document.querySelector(`.gift-box[data-id="${boxId}"]`);
    if (!boxElement) return;
     // –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–æ—Ä–æ–±–∫–∏ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—É—é
    const img = boxElement.querySelector('.box-img');
    if (img) {
        img.src = '/static/lab9/opened_box.png';
    }
    
    const container = boxElement.querySelector('.before-open-box');
    if (container) {
        container.className = 'after-open-box';
    }
    
    const status = boxElement.querySelector('.box-status');
    if (status) {
        status.textContent = '–û—Ç–∫—Ä—ã—Ç–∞';
    }
    
    const lock = boxElement.querySelector('.auth-lock');
    if (lock) {
        lock.style.display = 'none';
    }
    
    boxElement.classList.add('opened');
}



document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–æ—Ä–æ–±–∫–∏
    const boxes = document.querySelectorAll('.gift-box:not(.opened)');
    boxes.forEach(function(box) {
        box.addEventListener('click', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —É–∂–µ –∫–æ—Ä–æ–±–∫–∞
            if (this.classList.contains('opened')) {
                showError('–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!');
                return;
            }
            
            const boxId = this.dataset.id;
            openBox(parseInt(boxId));
        });
    });
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetAllBoxes);
    }
    
});
</script>
{% endblock %}